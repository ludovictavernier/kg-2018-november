<html>
<head>
    <style>
    
        a {
            font-size: 12px;
        }

        #title {
            font-family: "Noto Sans";
            font-size: 42;
            line-height: 110%;
        }

        #sub-title {
            margin-top: 5px;
            width: 375px;
        }

        #tooltip {
            display: none;
            height: 125px;
            width: 192px;
            border-radius: 4px;
            border: 1px solid #bbbbbb;
            background-color: rgb(255, 255, 255);
            box-shadow: 1px 2px 4px 0 rgba(0,0,0,0.4);
            font-family: Roboto;
            font-size: 12px;
        }

        .t-header {
            font-size: 20px;
            margin-bottom: 0px;
        }

        #net {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .red {
            font-family: "Noto Sans";
            color: #9C454C;
        }

        .blue {
            font-family: "Noto Sans";
            color: #4577A3;
        }

        .scale,select {
            margin-top: 15px;
        }

        .flex {
            display: flex;
            justify-content: space-between;
        }

        .flex .left {
            padding-top: 5px;
            margin-left: 25px;
        }

        .flex .right {
            padding-top: 5px;
            margin-right: 25px;
        }

    </style>
    <link rel="stylesheet" href="skeleton.css">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans:700|Raleway" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="title">Are More People Coming or Going?</div>
            <div id="sub-title">Below we look at how many people flowed <span class="blue">into</span> or <span class="red">out</span> of a short list of countries in 2015.</div>
        </div>
        <select class="u-full-width" id="country">
            <option>Australia</option>
            <option>Colombia</option>
            <option>France</option>
            <option>Indonesia</option>
            <option>Spain</option>
            <option>United Kingdom</option>
        </select>
        <div class="chart"></div>
        <div id="tooltip">
            <h3 class="t-header"></h3>
            <div id="net"></div>
            <div id="outflow"  class="flex">
                <div class="left" id="outflow"></div>
                <div class="right" id="outflow"></div>
            </div>
            <div id="inflow" class="flex">
                <div class="left"></div>
                <div class="right"></div>
            </div>
        </div>
        <button class="u-full-width scale">Change to Log Scale</button>
        <a class="six columns" href="https://stats.oecd.org/Index.aspx?DataSetCode=MIG">OECD.stat</a>
    </div>
</body>
<script>

    class Chart {

        constructor(opts) {
            // load in arguments from config object
            this.element = opts.element;
            this.data = opts.transformedData;
            
            // create the chart
            this.draw();
            
        }

        draw() {

            // Set the margin or outer spacing
            this.margin = {top: 10, right: 50, bottom: 0, left: 30},

            // Set the padding or innter spacing
            this.padding = {top: 10, right: 20, bottom: 20, left: 30},

            // Select the screen width and height
            this.outerWidth = 500,
            this.outerHeight = 450,

            // Subtract the margins to create space for the svg container
            this.innerWidth = this.outerWidth - (this.margin.left + this.margin.right),
            this.innerHeight = this.outerHeight - (this.margin.top + this.margin.bottom),

            // Subtract the padding to create space for the chart
            this.width = this.innerWidth - (this.padding.right + this.padding.left),
            this.height = this.innerHeight - (this.padding.top + this.padding.bottom);

            
            this.element.innerHTML = '';
            const svg = d3.select(this.element)
                .append('svg');

            svg
                .attr("width", this.outerWidth)
                .attr("height", this.outerHeight)
                .attr("translate", `transform(${[this.margin.left, this.margin.top]})`);

            this.plot = svg.append('g')
                .attr("translate", `transform(${[this.padding.left, this.padding.top]}))`);

            this.createScales();
            this.addAxes();
            this.addBarbells();
            this.addLabels();

        }

        createScales() {

            let scale = "";

            if (document.querySelector("button.scale").textContent === "Change to Log Scale") {
                scale = d3.scaleLinear();
            } else {
                scale = d3.scaleLog();
            }
            
            let outflowArr = [];
            let inflowArr = [];
            this.data.forEach(d => outflowArr.push(d.outflow));
            this.data.forEach(d => inflowArr.push(d.inflow));
            [this.minM, this.maxM] = d3.extent(outflowArr.concat(inflowArr));

            this.yScale = scale
                .domain([this.minM, this.maxM])
                .range([this.height, this.margin.top + this.padding.top]);

            this.cScale = d3.scaleOrdinal()
                .domain(["neg", "pos"])
                .range(["#9C454C", "#4577A3"]);

        }

        addAxes() {

            this.yAxis = d3.axisRight()
                .scale(this.yScale)
                .tickFormat(d3.format(".2s"))
                .tickSize( (this.margin.left + this.padding.left) - this.width * .85);

            this.yAxisG = this.plot
                .append("g")
                .attr("class", "y-axis")
                .attr("transform", `translate(${this.width}, 0 )`)
                .call(this.yAxis);

            this.yAxisG
                .selectAll("text")
                .style("font-family", "Roboto")
                .style("font-weight", "400")
                .style("font-size", "12px")
                .style("color", "#CECECE")

            this.yAxisG
                .selectAll("path")
                .style("display", "none")

            this.yAxisG
                .selectAll("line")
                .style("stroke", "#F1F1F1")

        }

        addBarbells() {
            let tooltip = d3.select("#tooltip");

            this.barbellG = this.plot.selectAll(".barbell")
                .data(this.data, d => d.country);
            

            this.barbellGEnter = this.barbellG
                .enter()
                .append("g")
                .attr("class", d => `barbell ${d["pos-or-neg"]}`)
                .style("opacity", .5)
                .on("mouseover.highlight", function(d) {

                this.classList.add("hovered")

                d3.selectAll(".barbell")
                .style("opacity", .3);

                d3.select(".hovered")
                .style("opacity", 1);

                })
                .on("mouseout.highlight", function(d) {                    
                this.classList.remove("hovered")

                d3.selectAll(".barbell")
                .style("opacity", .5);
                })
                .on("mouseover.tooltip", function() {
                tooltip.style("display", null);
                })
                .on("mousemove.tooltip", function(d) {

                tooltip.transition().duration(200)
                .style("display", "block")
                .style("opacity", 0.9);

                const commaFormat = d3.format(",");

                // position the tooltip
                tooltip
                .style("position", "fixed")
                .style("left", d3.event.clientX + 20)
                .style("top", d3.event.clientY + 20);

                // Add tooltip text
                tooltip.select("h3")
                .html(d.country)
                .style("font-size", "20px")
                .style("font-family", "Noto Sans")
                .style("text-align", "center")
                .style("margin-top", 10);

                tooltip.select("#net")
                .text(commaFormat(d.net))
                .style("color", "#5A6872")
                .style("font-family", "Roboto")
                .style("text-align", "center");

                tooltip.select("#outflow").select(".left")
                .text("OUTFLOW")

                tooltip.select("#outflow").select(".right")
                .text(commaFormat(d.outflow))

                tooltip.select("#inflow").select(".left")
                .text("INFLOW")

                tooltip.select("#inflow").select(".right")
                .text(commaFormat(d.inflow))

                })
                .on("mouseout.tooltip", function() {
                tooltip.style("display", "none");
                });

            this.barbellGEnter
                .merge(this.barbellG);

            this.barbellG.exit().remove();

            this.lines = this.barbellGEnter
                    .append("line")
                    .attr("class", "line")
                    .style("stroke-width", 3)
                .merge(this.barbellG.select("line"))
                    .attr("x1", this.margin.left + this.padding.left + (this.width * .25))
                    .attr("x2", this.margin.left + this.padding.left + (this.width * .75))
                    .attr("y1", d => this.yScale(d.outflow))
                    .attr("y2", d => this.yScale(d.inflow))
                    .attr("stroke", d => this.cScale(d["pos-or-neg"]));

            this.circlesOut = this.barbellGEnter
                    .append("circle")
                    .attr("r", 4)
                    .style("fill", d => this.cScale(d["pos-or-neg"]))
                .merge(this.barbellG.select("circle"))
                    .attr("cx", this.margin.left + this.padding.left + (this.width * .25))
                    .attr("cy", d => this.yScale(d.outflow));

            this.circlesIn = this.barbellGEnter
                    .append("circle")
                    .attr("r", 4)
                    .style("fill", d => this.cScale(d["pos-or-neg"]))
                .merge(this.barbellG.select("circle"))
                    .attr("cx", this.margin.left + this.padding.left + (this.width * .75))
                    .attr("cy", d => this.yScale(d.inflow));

        }

        addLabels() {
            
            const outflowLabel = this.plot
                .append("text")
                .attr("x", this.margin.left + this.padding.left + (this.width * .25))
                .attr("y", this.height)
                .attr("dy", 30)
                .attr("text-anchor", "middle")
                .text("OUTFLOW")
                .style("font-family", "Roboto")
                .style("font-size", "12px")
                .style("font-weight", "400")
                .style("fill", "#9C454C")
                .style("opacity", .5)
                .on("mouseover.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", 1);

                    d3.selectAll(".neg")
                        .style("opacity", 1);

                    d3.selectAll(".pos")
                        .style("opacity", .3);
                    
                })
                .on("mouseout.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", .5);

                    d3.selectAll(".barbell")
                        .style("opacity", .5);
                });
            
            const inflowLabel = this.plot
                .append("text")
                .attr("x", this.margin.left + this.padding.left + (this.width * .75))
                .attr("y", this.height)
                .attr("dy", 30)
                .attr("text-anchor", "middle")
                .text("INFLOW")
                .style("font-family", "Roboto")
                .style("font-size", "12px")
                .style("font-weight", "400")
                .style("fill", "#4577A3")
                .style("opacity", .5)
                .on("mouseover.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", 1);

                    d3.selectAll(".pos")
                        .style("opacity", 1);

                    d3.selectAll(".neg")
                        .style("opacity", .3);
                    
                })
                .on("mouseout.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", .5);

                    d3.selectAll(".barbell")
                        .style("opacity", .5);
                });
                    
        }

        changeToLogScale() {

            let scale = "";

            scale = d3.scaleLog();
            document.querySelector("button.scale").textContent = "Change to Linear Scale";

            const t = d3.transition()
                .duration(1000);

            this.yScale = scale
                .domain([this.minM, this.maxM])
                .range([this.height, this.margin.top + this.padding.top]);

            this.updateScale(scale, t);

        }

        changeToLinearScale() {

            let scale = "";

            scale = d3.scaleLinear();
            document.querySelector("button.scale").textContent = "Change to Log Scale";

            const t = d3.transition()
                .duration(1000);

            this.yScale = scale
                .domain([this.minM, this.maxM])
                .range([this.height, this.margin.top + this.padding.top]);

            this.updateScale(scale, t);

        }

        updateScale(scale, t) {

            this.yAxis = d3.axisRight()
                .scale(this.yScale)
                .tickFormat(d3.format(".2s"))
                .tickSize( (this.margin.left + this.padding.left) - this.width);

            this.yAxisG
                .transition(t)
                .call(this.yAxis);

            this.yAxisG
                .selectAll("text")
                .style("font-family", "Roboto")
                .style("font-weight", "400")
                .style("font-size", "12px")
                .style("color", "#CECECE")

            this.yAxisG
                .selectAll("path")
                .style("display", "none")

            this.yAxisG
                .selectAll("line")
                .style("stroke", "#F1F1F1")

            /*
            
            UPDATE ALL MARKS

            */

            this.lines
                .transition(t)
                .attr("y1", d => this.yScale(d.outflow))
                .attr("y2", d => this.yScale(d.inflow));

            this.circlesOut
                .transition(t)
                .attr("cy", d => this.yScale(d.outflow));

            this.circlesIn
                .transition(t)
                .attr("cy", d => this.yScale(d.inflow));

        }

        setData(newData, newTData) {
            this.data = newData;
            this.tData = newTData;

            // full redraw needed
            this.draw();
        }

    }

    d3.csv('OECD-data.csv').then(function(data) {

        initializeData(data);

        function initializeData(data, key = document.querySelector("#country").value) {

            // Nest data to remove redundant country rows
            const nested = d3.nest()
                .key(d => d["country"])
                .entries(data);

            // Pull out the current value from the dropdown menu
            let filtered = nested.filter( d => d.key === key);

            // Initialize a new data array to use in our visualization
            let tData = [];

            filtered[0].values.forEach(function(d) {
                tData.push({
                    country: d["foreign nationality"],
                    outflow: +d.outflow,
                    inflow: +d.inflow,
                    net: +d.inflow - +d.outflow,
                    "pos-or-neg": +d.inflow - +d.outflow >= 0 ? "pos" : "neg"
                })
            })

            let chart = new Chart({
                element: document.querySelector('.chart'),
                transformedData: tData
            });

            /*
            // MANGE THE CONTROLS CHANGING ON THE SCREEN
            */

            // Country drop down
            d3.select('#country').on('change', function() {

                initializeData(data, this.value);

            });

            // Changing the scale
            d3.selectAll('button').on('click', () => {

                if (document.querySelector("button.scale").textContent === "Change to Log Scale") {
                    chart.changeToLogScale();
                } else {
                    chart.changeToLinearScale();
                }

            });

        }
        
    });

</script>
</html>