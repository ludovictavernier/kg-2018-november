<html>
<head>
    <style>

        body {
            font-family: Roboto;
        }

        /* Header styling */
        #title {
            font-family: "Noto Sans";
            font-size: 42;
            line-height: 110%;
        }
        #sub-title {
            margin: 5px 0px 10px 0px;
            width: 375px;
            color: #afafaf;
        }
        .red {
            color: #9C454C;
            font-weight: bold;
        }
        .blue {
            color: #4577A3;
            font-weight: bold;
        }


        /* Tooltip formating */
        .flex {
            display: flex;
            justify-content: space-between;
        }
        .flex .left {
            padding-top: 5px;
            margin-left: 25px;
        }
        .flex .right {
            padding-top: 5px;
            margin-right: 25px;
        }
        #tooltip {
            display: none;
            height: 125px;
            width: 192px;
            border-radius: 4px;
            border: 1px solid #bbbbbb;
            background-color: rgb(255, 255, 255);
            box-shadow: 1px 1px 1px 0 rgba(0,0,0,0.4);
            font-family: Roboto;
            font-size: 12px;
        }
        .tt-header {
            font-size: 20px;
            font-family: Noto Sans;
            text-align: center;
            margin: 10 auto 0 auto;
        }
        #net {
            font-size: 14px;
            color: #5A6872;
            text-align: center;
            margin: 0 auto 10 auto;
        }

        /* y-axis formatting */
        .y-axis, text {
            font-weight: 400;
            font-size: 12px;
            color: #CECECE;
        }
        .y-axis path {
            display: none;
        }
        .tick line {
            stroke: #F1F1F1;
        }

        .v-line {
            stroke: black;
            stroke-dasharray: 3;
            opacity: .2;
        }

        /* Mark formatting */
        .pos > .line{
            stroke: #4577A3;
            stroke-width: 3;
        }
        .neg > .line{
            stroke: #9C454C;
            stroke-width: 3;
        }
        .pos > circle {
            fill: #4577A3;
        }
        .neg > circle {
            fill: #9C454C;
        }

        /* Lable formatting */
        .outflow-lable {
            text-anchor: middle;
            font-size: 12px;
            font-weight: 400;
            fill: #9C454C;
            opacity: .5;
        }
        .inflow-lable {
            text-anchor: middle;
            font-size: 12px;
            font-weight: 400;
            fill: #4577A3;
            opacity: .5;
        }
    </style>
    <link rel="stylesheet" href="skeleton.css">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans:700|Roboto" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="title">Are More People Coming or Going?</div>
            <div id="sub-title">Below we look at how many people flowed <span class="blue">into</span> or <span class="red">out</span> of a short list of countries in 2015.</div>
        </div>
        <select class="u-full-width" id="country">
            <option>Australia</option>
            <option>Colombia</option>
            <option>France</option>
            <option>Indonesia</option>
            <option>Spain</option>
            <option>United Kingdom</option>
        </select> 
        <div class="chart"></div>
        <div id="tooltip">
            <div class="tt-header"></div>
            <div id="net"></div>
            <div id="outflow"  class="flex">
                <div class="left" id="outflow"></div>
                <div class="right" id="outflow"></div>
            </div>
            <div id="inflow" class="flex">
                <div class="left"></div>
                <div class="right"></div>
            </div>
        </div>
        <button class="u-full-width scale">Change to Log Scale</button>
        <a class="six columns" href="https://stats.oecd.org/Index.aspx?DataSetCode=MIG">OECD.Stat</a>
    </div>
</body>
<script>

    class Chart {

        constructor(opts) {
            // load in arguments from config object
            this.element = opts.element;
            this.data = opts.transformedData;
            
            // create the chart
            this.draw();
            
        }

        draw() {

            // Set the margin or outer spacing
            this.margin = {top: 10, right: 50, bottom: 0, left: 30},

            // Set the padding or innter spacing
            this.padding = {top: 10, right: 20, bottom: 20, left: 30},

            // Select the screen width and height
            this.outerWidth = 500,
            this.outerHeight = 450,

            // Subtract the margins to create space for the svg container
            this.innerWidth = this.outerWidth - (this.margin.left + this.margin.right),
            this.innerHeight = this.outerHeight - (this.margin.top + this.margin.bottom),

            // Subtract the padding to create space for the chart
            this.width = this.innerWidth - (this.padding.right + this.padding.left),
            this.height = this.innerHeight - (this.padding.top + this.padding.bottom);

            
            this.element.innerHTML = '';
            const svg = d3.select(this.element)
                .append('svg');

            svg
                .attr("width", this.outerWidth)
                .attr("height", this.outerHeight)
                .attr("translate", `transform(${[this.margin.left, this.margin.top]})`);

            this.plot = svg.append('g')
                .attr("translate", `transform(${[this.padding.left, this.padding.top]}))`);

            this.createScales();
            this.addAxes();
            this.addBarbells();
            this.addLabels();

        }

        createScales() {

            let scale = "";

            if (document.querySelector("button.scale").textContent === "Change to Log Scale") {
                scale = d3.scaleLinear();
            } else {
                scale = d3.scaleLog();
            }
            
            // I did to grab the min and max of the entire dataset.
            let outflowArr = [];
            let inflowArr = [];
            this.data.forEach(d => outflowArr.push(d.outflow));
            this.data.forEach(d => inflowArr.push(d.inflow));
            [this.minM, this.maxM] = d3.extent(outflowArr.concat(inflowArr));

            this.yScale = scale
                .domain([this.minM, this.maxM])
                .range([this.height, this.margin.top + this.padding.top]);

            this.cScale = d3.scaleOrdinal()
                .domain(["neg", "pos"])
                .range(["#9C454C", "#4577A3"]);

        }

        addAxes() {

            this.yAxis = d3.axisRight()
                .scale(this.yScale)
                .tickFormat(d3.format(".2s"))
                .tickSize( (this.margin.left + this.padding.left) - this.width * .85);

            this.yAxisG = this.plot
                .append("g")
                .attr("class", "y-axis")
                .attr("transform", `translate(${this.width}, 0 )`)
                .call(this.yAxis);
                
            // Create two vertical lines to create alignment of our point along the y-axis.
            this.plot
                .append("line")
                    .classed("v-line", true)
                    .attr("x1", this.innerWidth - (this.padding.right + this.margin.right + 12))
                    .attr("y1", 0)
                    .attr("x2", this.innerWidth - (this.padding.right + this.margin.right + 12))
                    .attr("y2", this.height)

            this.plot
                .append("line")
                    .classed("v-line", true)
                    .attr("x1", this.width * .25 + this.padding.left + this.margin.left)
                    .attr("y1", 0)
                    .attr("x2", this.width * .25 + this.padding.left + this.margin.left)
                    .attr("y2", this.height);

        }

        addBarbells() {
            let tooltip = d3.select("#tooltip");

            this.barbellG = this.plot.selectAll(".barbell")
                .data(this.data, d => d.country);

            this.barbellGEnter = this.barbellG
                .enter()
                .append("g")
                .attr("class", d => `barbell ${d["pos-or-neg"]}`)
                .style("opacity", .5);

            this.barbellGEnter
                .on("mouseover.highlight", function(d) {

                    this.classList.add("hovered")

                    d3.selectAll(".barbell")
                    .style("opacity", .3);

                    d3.select(".hovered")
                    .style("opacity", 1);

                })
                .on("mouseout.highlight", function(d) {                    
                    this.classList.remove("hovered")

                    d3.selectAll(".barbell")
                    .style("opacity", .5);
                })

            this.barbellGEnter
                .on("mouseover.tooltip", function() {
                    tooltip.style("display", null);
                })
                .on("mousemove.tooltip", function(d) {

                    tooltip.transition()
                        .style("display", "block")
                        .style("opacity", 0.9);

                    const commaFormat = d3.format(",");

                    // Positioning the tooltip to the bottom right of your cursor
                    tooltip
                        .style("position", "fixed")
                        .style("left", d3.event.clientX + 20)
                        .style("top", d3.event.clientY + 20);

                    // Creating the country header
                    tooltip.select(".tt-header")
                        .html(d.country)

                    // Add the the subtitle of Net value
                    tooltip.select("#net")
                        .text(commaFormat(d.net))
                    
                    // Adding the INLFOW OUTFLOW data
                    tooltip.select("#outflow").select(".left")
                        .text("OUTFLOW")
                    tooltip.select("#outflow").select(".right")
                        .text(commaFormat(d.outflow))
                    tooltip.select("#inflow").select(".left")
                        .text("INFLOW")
                    tooltip.select("#inflow").select(".right")
                        .text(commaFormat(d.inflow))

                })
                .on("mouseout.tooltip", function() {
                    tooltip.style("display", "none");
                });

            this.barbellGEnter
                .merge(this.barbellG);

            this.barbellG.exit().remove();

            this.lines = this.barbellGEnter
                    .append("line")
                    .classed("line", true)
                .merge(this.barbellG.select("line"))
                    .attr("x1", this.margin.left + this.padding.left + (this.width * .25))
                    .attr("x2", this.margin.left + this.padding.left + (this.width * .75))
                    .attr("y1", d => this.yScale(d.outflow))
                    .attr("y2", d => this.yScale(d.inflow))

            this.circlesOut = this.barbellGEnter
                    .append("circle")
                    .attr("r", 4)
                .merge(this.barbellG.select("circle"))
                    .attr("cx", this.margin.left + this.padding.left + (this.width * .25))
                    .attr("cy", d => this.yScale(d.outflow));

            this.circlesIn = this.barbellGEnter
                    .append("circle")
                    .attr("r", 4)
                .merge(this.barbellG.select("circle"))
                    .attr("cx", this.margin.left + this.padding.left + (this.width * .75))
                    .attr("cy", d => this.yScale(d.inflow));

        }

        addLabels() {
            
            const outflowLabel = this.plot
                .append("text")
                .classed("outflow-lable", true)
                .attr("x", this.margin.left + this.padding.left + (this.width * .25))
                .attr("y", this.height)
                .attr("dy", 30)
                .text("OUTFLOW")
                .on("mouseover.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", 1);

                    d3.selectAll(".neg")
                        .style("opacity", 1);

                    d3.selectAll(".pos")
                        .style("opacity", .3);
                    
                })
                .on("mouseout.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", .5);

                    d3.selectAll(".barbell")
                        .style("opacity", .5);
                });
            

            const inflowLabel = this.plot
                .append("text")
                .classed("inflow-lable", true)
                .attr("x", this.margin.left + this.padding.left + (this.width * .75))
                .attr("y", this.height)
                .attr("dy", 30)
                .text("INFLOW")
                .on("mouseover.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", 1);

                    d3.selectAll(".pos")
                        .style("opacity", 1);

                    d3.selectAll(".neg")
                        .style("opacity", .3);
                    
                })
                .on("mouseout.highlight", function(d) {
                    d3.select(this)
                        .style("opacity", .5);

                    d3.selectAll(".barbell")
                        .style("opacity", .5);
                });
                    
        }

        changeToLogScale() {

            let scale = "";

            scale = d3.scaleLog();
            document.querySelector("button.scale").textContent = "Change to Linear Scale";

            const t = d3.transition()
                .duration(1000);

            this.yScale = scale
                .domain([this.minM, this.maxM])
                .range([this.height, this.margin.top + this.padding.top]);

            this.updateScale(scale, t);

        }

        changeToLinearScale() {

            let scale = "";

            scale = d3.scaleLinear();
            document.querySelector("button.scale").textContent = "Change to Log Scale";

            const t = d3.transition()
                .duration(1000);

            this.yScale = scale
                .domain([this.minM, this.maxM])
                .range([this.height, this.margin.top + this.padding.top]);

            this.updateScale(scale, t);

        }

        updateScale(scale, t) {

            this.yAxis = d3.axisRight()
                .scale(this.yScale)
                .tickFormat(d3.format(".2s"))
                .tickSize( (this.margin.left + this.padding.left) - this.width);

            this.yAxisG
                .transition(t)
                .call(this.yAxis);

            /*
            
            UPDATE ALL MARKS

            */

            this.lines
                .transition(t)
                .attr("y1", d => this.yScale(d.outflow))
                .attr("y2", d => this.yScale(d.inflow));

            this.circlesOut
                .transition(t)
                .attr("cy", d => this.yScale(d.outflow));

            this.circlesIn
                .transition(t)
                .attr("cy", d => this.yScale(d.inflow));

        }

        setData(newData, newTData) {
            this.data = newData;
            this.tData = newTData;

            // full redraw needed
            this.draw();
        }

    }

    d3.csv('OECD-data.csv').then(function(data) {

        initializeData(data);

        function initializeData(data, key = document.querySelector("#country").value) {

            // Nest data to remove redundant country rows
            const nested = d3.nest()
                .key(d => d["country"])
                .entries(data);

            // Pull out the current value from the dropdown menu
            let filtered = nested.filter( d => d.key === key);

            // Initialize a new data array to use in our visualization
            let tData = [];

            filtered[0].values.forEach(function(d) {
                tData.push({
                    country: d["foreign nationality"],
                    outflow: +d.outflow,
                    inflow: +d.inflow,
                    net: +d.inflow - +d.outflow,
                    "pos-or-neg": +d.inflow - +d.outflow >= 0 ? "pos" : "neg"
                })
            })

            let chart = new Chart({
                element: document.querySelector('.chart'),
                transformedData: tData
            });

            /*
            // MANGE THE CONTROLS CHANGING ON THE SCREEN
            */

            // Country drop down
            d3.select('#country').on('change', function() {

                initializeData(data, this.value);

            });

            // Changing the scale
            d3.selectAll('button').on('click', () => {

                if (document.querySelector("button.scale").textContent === "Change to Log Scale") {
                    chart.changeToLogScale();
                } else {
                    chart.changeToLinearScale();
                }

            });

        }
        
    });

</script>
</html>